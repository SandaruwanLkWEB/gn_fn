<!doctype html>
<html lang="si">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#E11D48" />
  <title>üöå ‡∂Ö‡∂Ø ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î - Employee Dashboard</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <script src="assets/config.js"></script>
  <script src="assets/app.js"></script>
  <style>
    /* Enhanced employee dashboard styles */
    .dashboard-header {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: white;
      padding: 24px;
      border-radius: var(--r-lg);
      margin-bottom: 20px;
      box-shadow: var(--glow-brand), var(--shadow-lg);
      animation: fadeInDown 0.6s ease;
    }
    
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    
    .info-card {
      background: var(--glass-bg);
      backdrop-filter: var(--blur-md);
      border: 1px solid var(--glass-border);
      border-radius: var(--r-md);
      padding: 18px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      animation: fadeInUp 0.6s ease both;
    }
    
    .info-card:nth-child(1) { animation-delay: 0.1s; }
    .info-card:nth-child(2) { animation-delay: 0.2s; }
    .info-card:nth-child(3) { animation-delay: 0.3s; }
    .info-card:nth-child(4) { animation-delay: 0.4s; }
    .info-card:nth-child(5) { animation-delay: 0.5s; }
    .info-card:nth-child(6) { animation-delay: 0.6s; }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .info-card:hover {
      background: var(--surface-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .info-label {
      font-size: 13px;
      color: var(--muted-2);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    
    .info-value {
      font-size: 20px;
      font-weight: 900;
      color: var(--text);
      word-break: break-word;
    }
    
    .no-transport-card {
      text-align: center;
      padding: 48px 24px;
      animation: fadeInUp 0.6s ease;
    }
    
    .instructions-box {
      background: linear-gradient(135deg, rgba(225, 29, 72, 0.08), rgba(225, 29, 72, 0.04));
      border: 1px solid rgba(225, 29, 72, 0.2);
      border-radius: var(--r-md);
      padding: 16px;
      margin-top: 20px;
      backdrop-filter: var(--blur-sm);
    }
    
    @media(max-width: 640px) {
      .dashboard-header { padding: 18px; }
      .info-grid { grid-template-columns: 1fr; }
      .info-value { font-size: 18px; }
    }
  </style>
</head>
<body>

<header>
  <h1>üöå ‡∂Ö‡∂Ø ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î</h1>
  <div style="display:flex; gap:8px; align-items:center;">
    <a href="index.html" class="btn ghost small">üè† Home</a>
    <button class="btn secondary small" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">
  
  <div class="card elevated" id="meBox" style="margin-bottom:18px; padding:14px 20px;">
    Loading...
  </div>

  <div class="dashboard-header">
    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">
      üìÖ <span id="currentDate"></span>
    </div>
    <div style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">
      ‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä! üëã
    </div>
    <div style="font-size: 14px; opacity: 0.95;" id="statusMessage">
      ‡∂î‡∂∂‡∂ú‡∑ö ‡∂Ö‡∂Ø ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...
    </div>
  </div>

  <div class="card elevated" id="transportBox">
    <div id="loadingState" style="text-align:center; padding:32px;">
      <div style="font-size:48px; margin-bottom:16px;">‚è≥</div>
      <div style="font-weight:700; font-size:18px;">‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</div>
      <div class="p-muted" style="margin-top:8px;">‡∂î‡∂∂‡∂ú‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂Ω‡∂∂‡∑è ‡∂ú‡∂±‡∑í‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì</div>
    </div>
    <div id="contentArea" style="display:none;"></div>
  </div>

  <div class="card" style="margin-top:18px; display:none;" id="quickActions">
    <h3 class="h2">‚ö° Quick Actions</h3>
    <div class="btnrow" style="margin-top:12px;">
      <button class="btn" onclick="refreshTransport()">üîÑ Refresh</button>
      <button class="btn ghost" onclick="window.print()">üñ®Ô∏è Print</button>
    </div>
  </div>

</div>

<script>
let ME = null;

async function guard(){
  try {
    ME = await guardRole("EMP");
    if(!ME) return;
    qs("meBox").innerHTML = `
      <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
        <span class="badge brand">${ME.role}</span>
        <span style="font-weight:600;">${ME.email}</span>
        <span class="badge ok" style="margin-left:auto;">‚úÖ Active</span>
      </div>
    `;
  } catch(e) {
    location.href = "login.html";
  }
}

function setCurrentDate() {
  const today = new Date();
  const options = { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' };
  qs("currentDate").textContent = today.toLocaleDateString('en-US', options);
}

async function loadToday(){
  const loadingState = qs("loadingState");
  const contentArea = qs("contentArea");
  const statusMsg = qs("statusMessage");
  const quickActions = qs("quickActions");
  
  try {
    loadingState.style.display = "block";
    contentArea.style.display = "none";
    
    const data = await api("/emp/today-transport");
    
    loadingState.style.display = "none";
    contentArea.style.display = "block";
    
    if(!data.has_transport){
      statusMsg.textContent = "‡∂Ö‡∂Ø ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂¥‡∑Ñ‡∑É‡∑î‡∂ö‡∂∏‡∑ä ‡∂Ö‡∂±‡∑î‡∂∫‡∑î‡∂ö‡∑ä‡∂≠ ‡∂ö‡∂ª ‡∂±‡∑ê‡∂≠";
      const msg = data.message || "‡∂î‡∂∂‡∂ß ‡∂Ö‡∂Ø ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂¥‡∑Ñ‡∑É‡∑î‡∂ö‡∂∏‡∑ä ‡∂Ö‡∂±‡∑î‡∂∫‡∑î‡∂ö‡∑ä‡∂≠ ‡∂ö‡∂ª ‡∂±‡∑ê‡∂≠.";
      const hint = data.hint || "‡∂î‡∂∂ ‡∂Ö‡∂∏‡∂≠‡∂ö ‡∑Ä‡∑ì ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂±‡∑ú‡∑Ä‡∑ñ ‡∂∂‡∑Ä ‡∑É‡∑í‡∂≠‡∑ô‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∂∏‡∑ä ‡∑Ñ‡∑ê‡∂ö‡∑í ‡∂â‡∂ö‡∑ä‡∂∏‡∂±‡∑í‡∂±‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂Ö‡∂∞‡∑í‡∂ö‡∑è‡∂ª‡∑í‡∂∫ ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂±.";
      const phone = (data.ta_contact && data.ta_contact.phone) ? data.ta_contact.phone : "";
      
      contentArea.innerHTML = `
        <div class="no-transport-card">
          <div style="font-size:64px; margin-bottom:16px; opacity:0.6;">üöåüí®</div>
          <h2 style="font-size:24px; margin-bottom:12px;">${msg}</h2>
          <p class="p-muted" style="max-width:500px; margin:0 auto 16px;">${hint}</p>
          ${phone ? `<a href="tel:${phone}" class="btn btn-primary">üìû TA ‡∂Ö‡∂∏‡∂≠‡∂±‡∑ä‡∂±: ${phone}</a>` : ""}
        </div>
      `;
      return;
    }

    statusMsg.textContent = "‚úÖ ‡∂î‡∂∂‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂¥‡∑Ñ‡∑É‡∑î‡∂ö‡∂∏‡∑ä ‡∂Ö‡∂±‡∑î‡∂∫‡∑î‡∂ö‡∑ä‡∂≠ ‡∂ö‡∂ª ‡∂á‡∂≠";
    
    const route = data.route || {};
    const sub = data.sub_route || {};
    const vehicles = data.vehicles || [];
    const v0 = vehicles[0] || {};

    contentArea.innerHTML = `
      <h2 class="h2" style="margin:0 0 20px;">üéØ ‡∂Ö‡∂Ø‡∂ß ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑è‡∑Ñ‡∂± ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª</h2>

      <div class="info-grid">
        <div class="info-card">
          <div class="info-label">üìç ‡∂ú‡∂∏‡∂± ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∂ö‡∂ª‡∂± ‡∑É‡∑ä‡∂Æ‡∑è‡∂±‡∂∫</div>
          <div class="info-value">${sub.sub_name || "‚Äî"}</div>
        </div>

        <div class="info-card">
          <div class="info-label">üõ£Ô∏è ‡∂∏‡∑è‡∂ª‡∑ä‡∂ú‡∂∫ (Route)</div>
          <div class="info-value">
            ${route.route_no || "‚Äî"}
            ${route.route_name ? `<div style="font-size:14px; font-weight:600; color:var(--muted); margin-top:4px;">${route.route_name}</div>` : ""}
          </div>
        </div>

        <div class="info-card">
          <div class="info-label">üöó ‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∂Ö‡∂Ç‡∂ö‡∂∫</div>
          <div class="info-value">${v0.vehicle_registration_no || v0.registration_no || "‚Äî"}</div>
        </div>

        <div class="info-card">
          <div class="info-label">üî¢ ‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫</div>
          <div class="info-value">
            ${v0.vehicle_no || "‚Äî"}
            ${v0.fleet_no ? `<div style="font-size:14px; font-weight:600; color:var(--muted); margin-top:4px;">Fleet: ${v0.fleet_no}</div>` : ""}
          </div>
        </div>

        <div class="info-card">
          <div class="info-label">üë§ ‡∂ª‡∑í‡∂∫‡∂Ø‡∑î‡∂ª‡∑î ‡∂±‡∂∏</div>
          <div class="info-value">${v0.driver_name || "‚Äî"}</div>
        </div>

        <div class="info-card">
          <div class="info-label">üì± ‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫</div>
          <div class="info-value">
            ${v0.driver_phone ? `<a href="tel:${v0.driver_phone}" style="color:var(--brand);">${v0.driver_phone}</a>` : "‚Äî"}
          </div>
        </div>
      </div>

      ${v0.instructions ? `
        <div class="instructions-box">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
            <span style="font-size:20px;">üìã</span>
            <strong>‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç ‡∂ã‡∂¥‡∂Ø‡∑ô‡∑É‡∑ä:</strong>
          </div>
          <div style="line-height:1.6;">${v0.instructions}</div>
        </div>
      ` : ""}

      ${vehicles.length > 1 ? `
        <div style="margin-top:20px;">
          <h3 class="h2">üöå ‡∂Ö‡∂∏‡∂≠‡∂ª ‡∑Ä‡∑è‡∑Ñ‡∂± (${vehicles.length - 1})</h3>
          <div class="info-grid" style="margin-top:12px;">
            ${vehicles.slice(1).map((v, i) => `
              <div class="info-card">
                <div class="info-label">üöó ‡∑Ä‡∑è‡∑Ñ‡∂±‡∂∫ ${i + 2}</div>
                <div class="info-value" style="font-size:16px;">
                  ${v.vehicle_registration_no || "‚Äî"}
                  ${v.driver_name ? `<div style="font-size:13px; color:var(--muted); margin-top:4px;">üë§ ${v.driver_name}</div>` : ""}
                  ${v.driver_phone ? `<div style="font-size:13px; color:var(--brand); margin-top:2px;">üì± ${v.driver_phone}</div>` : ""}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ""}
    `;

    quickActions.style.display = "block";
    
  } catch(e) {
    console.error('Error:', e);
    loadingState.style.display = "none";
    contentArea.style.display = "block";
    statusMsg.textContent = "‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∑É‡∑í‡∂Ø‡∑î ‡∑Ä‡∑í‡∂∫";
    
    contentArea.innerHTML = `
      <div class="no-transport-card">
        <div style="font-size:64px; margin-bottom:16px;">‚ö†Ô∏è</div>
        <h2 style="font-size:24px; margin-bottom:12px;">‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö‡∑í ‡∑Ä‡∑í‡∂∫</h2>
        <p class="p-muted">${e.message}</p>
        <button class="btn btn-primary" onclick="refreshTransport()" style="margin-top:16px;">üîÑ ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
      </div>
    `;
  }
}

async function refreshTransport() {
  toast('üîÑ ‡∂±‡∑ê‡∑Ä‡∑î‡∂∏‡∑ä ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä...');
  await loadToday();
  toast('‚úÖ ‡∂±‡∑ê‡∑Ä‡∑î‡∂∏‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì!');
}

(async function init(){
  try {
    setCurrentDate();
    await guard();
    await loadToday();
  } catch(e) {
    toast('‚ùå ' + e.message);
  }
})();

// Auto-refresh every 5 minutes
setInterval(() => { loadToday(); }, 5 * 60 * 1000);
</script>

</body>
</html>
