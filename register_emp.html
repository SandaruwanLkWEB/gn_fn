<!doctype html>
<html lang="si">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#E11D48"/>
  <title>üë§ ‡∑É‡∑ö‡∑Ä‡∂ö ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∑ì‡∂∏</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <script src="assets/config.js"></script>
  <script src="assets/app.js"></script>
  <style>
    .form-section {
      animation: fadeIn 0.4s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

<div class="topbar">
  <div class="inner">
    <div class="brand">
      <span class="dot"></span> 
      ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂ö‡∑Ö‡∂∏‡∂´‡∑è‡∂ö‡∂ª‡∂´ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫
    </div>
    <div class="nav">
      <a class="btn ghost" href="login.html">üîì ‡∂á‡∂≠‡∑î‡∂Ω‡∑ä‡∑Ä‡∑ì‡∂∏</a>
      <a class="btn" href="register.html">‚¨ÖÔ∏è ‡∂Ü‡∂¥‡∑É‡∑î</a>
    </div>
  </div>
</div>

<div class="container">
  <h1 class="h1">üë§ ‡∑É‡∑ö‡∑Ä‡∂ö ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∑ì‡∂∏</h1>
  <p class="p-muted">‡∂î‡∂∂‡∂ú‡∑ö ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂¥‡∑î‡∂ª‡∑Ä‡∑è ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∂±‡∑ä‡∂±. HOD ‡∂Ö‡∂±‡∑î‡∂∏‡∑ê‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑ä ‡∂¥‡∑É‡∑î ‡∂î‡∂∂‡∂ß ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö‡∑í‡∂∫.</p>
  
  <div class="card elevated form-section">
    
    <!-- Loading Indicator -->
    <div id="loadingDepts" class="alert" style="display:none;">
      ‚è≥ ‡∂Ø‡∑ô‡∂¥‡∑è‡∂ª‡∑ä‡∂≠‡∂∏‡∑ö‡∂±‡∑ä‡∂≠‡∑î ‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...
    </div>
    
    <!-- Error Alert -->
    <div id="deptError" class="alert error hidden"></div>
    
    <!-- Success/Error Message -->
    <div id="msg" class="alert hidden"></div>
    
    <div class="grid two">
      <div>
        <label>üë§ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂±‡∂∏</label>
        <input 
          id="emp_name" 
          placeholder="‡∑É‡∂∏‡∂ú ‡∂¥‡∑ä‚Äç‡∂ª‡∂±‡∑è‡∂±‡∑ä‡∂Ø‡∑î"
          autocomplete="name"
          required
        />
        
        <label>üÜî ‡∑É‡∑ö‡∑Ä‡∂ö ‡∂Ö‡∂Ç‡∂ö‡∂∫ (Emp No)</label>
        <input 
          id="emp_no" 
          placeholder="‡∂ã‡∂Ø‡∑è: 20482"
          autocomplete="off"
          required
        />
        
        <label>üìß ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑î‡∂≠‡∑ä ‡∂≠‡∑ê‡∂¥‡∑ë‡∂Ω</label>
        <input 
          id="email" 
          type="email" 
          placeholder="name@example.com"
          autocomplete="email"
          required
        />
      </div>
      
      <div>
        <label>üè¢ ‡∂Ø‡∑ô‡∂¥‡∑è‡∂ª‡∑ä‡∂≠‡∂∏‡∑ö‡∂±‡∑ä‡∂≠‡∑î‡∑Ä</label>
        <select id="department_id" required>
          <option value="">‚è≥ ‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</option>
        </select>
        
        <label>üîí ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫</label>
        <input 
          id="password" 
          type="password" 
          placeholder="‡∂Ö‡∑Ä‡∂∏ ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î 6"
          autocomplete="new-password"
          minlength="6"
          required
        />
        
        <label>üîí ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</label>
        <input 
          id="password_confirm" 
          type="password" 
          placeholder="‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ß‡∂∫‡∑í‡∂¥‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"
          autocomplete="new-password"
          minlength="6"
          required
        />
      </div>
    </div>
    
    <div class="toolbar" style="margin-top:18px;">
      <div class="btnrow" style="width:100%;">
        <button class="btn btn-primary" id="btnReg" style="width:100%; justify-content:center;">
          ‚úÖ ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∂±‡∑ä‡∂±
        </button>
      </div>
    </div>
    
    <p class="p-muted" style="margin-top:18px; text-align:center; font-size:13px;">
      ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ö‡∑ä ‡∂≠‡∑í‡∂∂‡∑ö‡∂Ø? 
      <a href="login.html" style="color:var(--brand); font-weight:700;">‡∂á‡∂≠‡∑î‡∂Ω‡∑ä ‡∑Ä‡∂±‡∑ä‡∂± ‚Üí</a>
    </p>
  </div>
</div>

<script>
// Load departments with error handling
(async ()=>{
  const sel = document.getElementById("department_id");
  const loadingDiv = document.getElementById("loadingDepts");
  const errorDiv = document.getElementById("deptError");
  
  try {
    // Show loading
    loadingDiv.style.display = 'block';
    sel.disabled = true;
    
    const d = await api("/public/departments");
    const departments = d.departments || [];
    
    if(departments.length === 0) {
      throw new Error("‡∂Ø‡∑ô‡∂¥‡∑è‡∂ª‡∑ä‡∂≠‡∂∏‡∑ö‡∂±‡∑ä‡∂≠‡∑î ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫");
    }
    
    // Populate dropdown
    sel.innerHTML = '<option value="">-- ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂± --</option>' + 
      departments.map(x => `<option value="${x.id}">${x.name}</option>`).join("");
    
    // Hide loading
    loadingDiv.style.display = 'none';
    sel.disabled = false;
    
  } catch(e) {
    console.error('Department load error:', e);
    
    // Show error
    loadingDiv.style.display = 'none';
    errorDiv.textContent = "‚ö†Ô∏è ‡∂Ø‡∑ô‡∂¥‡∑è‡∂ª‡∑ä‡∂≠‡∂∏‡∑ö‡∂±‡∑ä‡∂≠‡∑î ‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö‡∑í ‡∑Ä‡∑í‡∂∫: " + e.message;
    errorDiv.classList.remove("hidden");
    
    // Fallback dropdown
    sel.innerHTML = '<option value="">‡∂Ø‡∑ô‡∂¥‡∑è‡∂ª‡∑ä‡∂≠‡∂∏‡∑ö‡∂±‡∑ä‡∂≠‡∑î ‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∂Ö‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í</option>';
    sel.disabled = true;
  }
})();

// Form validation helper
function validateForm() {
  const emp_name = document.getElementById("emp_name").value.trim();
  const emp_no = document.getElementById("emp_no").value.trim();
  const email = document.getElementById("email").value.trim();
  const department_id = document.getElementById("department_id").value;
  const password = document.getElementById("password").value;
  const password_confirm = document.getElementById("password_confirm").value;
  
  if(!emp_name) return "‚ö†Ô∏è ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂î‡∂∂‡∂ú‡∑ö ‡∂±‡∂∏ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±";
  if(!emp_no) return "‚ö†Ô∏è ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑É‡∑ö‡∑Ä‡∂ö ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±";
  if(!email) return "‚ö†Ô∏è ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑î‡∂≠‡∑ä ‡∂≠‡∑ê‡∂¥‡∑ë‡∂Ω ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±";
  if(!email.includes('@')) return "‚ö†Ô∏è ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑î‡∂≠‡∑ä ‡∂≠‡∑ê‡∂¥‡∑ê‡∂Ω‡∑ä ‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±";
  if(!department_id) return "‚ö†Ô∏è ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ø‡∑ô‡∂¥‡∑è‡∂ª‡∑ä‡∂≠‡∂∏‡∑ö‡∂±‡∑ä‡∂≠‡∑î‡∑Ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±";
  if(!password) return "‚ö†Ô∏è ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±";
  if(password.length < 6) return "‚ö†Ô∏è ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∂Ö‡∑Ä‡∂∏ ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î 6‡∂ö‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫";
  if(password !== password_confirm) return "‚ö†Ô∏è ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø ‡∂ú‡∑ê‡∂Ω‡∂¥‡∑ô‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∑ê‡∂≠. ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±";
  
  return null;
}

// Registration handler
document.getElementById("btnReg").onclick = async ()=>{
  const msg = document.getElementById("msg");
  const btn = document.getElementById("btnReg");
  
  // Validate
  const validationError = validateForm();
  if(validationError) {
    msg.textContent = validationError;
    msg.className = "alert error";
    return;
  }
  
  const payload = {
    emp_name: document.getElementById("emp_name").value.trim(),
    emp_no: document.getElementById("emp_no").value.trim(),
    email: document.getElementById("email").value.trim(),
    department_id: document.getElementById("department_id").value,
    password: document.getElementById("password").value
  };
  
  msg.className = "alert hidden";
  btn.disabled = true;
  btn.textContent = "‚è≥ ‡∂∫‡∑ú‡∂∏‡∑î ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä...";
  
  try {
    const response = await api("/auth/register", { 
      method: "POST", 
      body: JSON.stringify(payload) 
    });
    
    // Success
    msg.textContent = "‚úÖ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í! ‡∂î‡∂∂‡∂ú‡∑ö ‡∂ú‡∑í‡∂´‡∑î‡∂∏ HOD ‡∂Ö‡∂±‡∑î‡∂∏‡∑ê‡∂≠‡∑í‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂∫‡∑ú‡∂∏‡∑î ‡∂ö‡∂ª ‡∂á‡∂≠. ‡∂î‡∂∂‡∂ß ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑î‡∂≠‡∑ä ‡∂≠‡∑ê‡∂¥‡∑ë‡∂Ω‡∑ô‡∂±‡∑ä ‡∂Ø‡∑ê‡∂±‡∑î‡∂∏‡∑ä‡∂Ø‡∑ì‡∂∏‡∂ö‡∑ä ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂±‡∑î ‡∂á‡∂≠.";
    msg.className = "alert ok";
    
    // Clear form
    document.getElementById("emp_name").value = "";
    document.getElementById("emp_no").value = "";
    document.getElementById("email").value = "";
    document.getElementById("department_id").value = "";
    document.getElementById("password").value = "";
    document.getElementById("password_confirm").value = "";
    
    btn.textContent = "‚úÖ ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∂±‡∑ä‡∂±";
    btn.disabled = false;
    
    // Redirect after 3 seconds
    setTimeout(() => {
      location.href = "login.html";
    }, 3000);
    
  } catch(e) {
    console.error('Registration error:', e);
    
    // Enhanced error messages
    let errorMsg = e.message || "‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í‡∂∫ ‡∂Ö‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í";
    
    // Make errors more user-friendly
    if(errorMsg.includes("duplicate") || errorMsg.includes("exists")) {
      errorMsg = "‚ö†Ô∏è ‡∂∏‡∑ô‡∂∏ ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑î‡∂≠‡∑ä ‡∂≠‡∑ê‡∂¥‡∑ë‡∂Ω ‡∑Ñ‡∑ù ‡∑É‡∑ö‡∑Ä‡∂ö ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂Ø‡∑ê‡∂±‡∂ß‡∂∏‡∂≠‡∑ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∑Ä‡∑ö";
    } else if(errorMsg.includes("invalid") || errorMsg.includes("validation")) {
      errorMsg = "‚ö†Ô∏è ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∑Ä ‡∂¥‡∑î‡∂ª‡∑Ä‡∑è ‡∂á‡∂≠‡∑í ‡∂Ø‡∑ê‡∂∫‡∑í ‡∑É‡∂Ω‡∂ö‡∑è ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±";
    } else if(errorMsg.includes("network") || errorMsg.includes("fetch")) {
      errorMsg = "‚ö†Ô∏è ‡∑É‡∂ª‡∑ä‡∑Ä‡∂ª‡∑ä ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞‡∂≠‡∑è ‡∂ú‡∑ê‡∂ß‡∂Ω‡∑î‡∑Ä‡∂ö‡∑ä. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±";
    } else if(errorMsg.includes("500") || errorMsg.includes("Server error")) {
      errorMsg = "‚ö†Ô∏è ‡∑É‡∂ª‡∑ä‡∑Ä‡∂ª‡∑ä ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∑É‡∑î‡∑Ä ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±";
    }
    
    msg.textContent = "‚ùå " + errorMsg;
    msg.className = "alert error";
    btn.textContent = "‚úÖ ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∂±‡∑ä‡∂±";
    btn.disabled = false;
  }
};

// Enter key support
document.querySelectorAll('input').forEach((input, index, inputs) => {
  input.addEventListener('keypress', (e) => {
    if(e.key === 'Enter') {
      e.preventDefault();
      if(index < inputs.length - 1) {
        inputs[index + 1].focus();
      } else {
        document.getElementById("btnReg").click();
      }
    }
  });
});
</script>

</body>
</html>
