<!doctype html>
<html lang="si">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#E11D48"/>
  <title>üîê ‡∂á‡∂≠‡∑î‡∂Ω‡∑ä‡∑Ä‡∑ì‡∂∏ - Transport Management</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <script src="assets/config.js"></script>
  <script src="assets/app.js"></script>
  <style>
    /* Enhanced login page styles */
    .login-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-card {
      width: 100%;
      max-width: 480px;
      animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .logo-section {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .logo-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      border-radius: var(--r-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      box-shadow: var(--glow-brand), var(--shadow-lg);
      animation: pulse-glow 3s ease-in-out infinite;
    }
    
    .logo-title {
      font-size: 28px;
      font-weight: 900;
      background: linear-gradient(135deg, var(--text), var(--muted));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
    }
    
    .logo-subtitle {
      color: var(--muted);
      margin-top: 8px;
      font-size: 14px;
    }
    
    .input-group {
      margin-bottom: 18px;
    }
    
    .input-with-icon {
      position: relative;
    }
    
    .input-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted-2);
      font-size: 18px;
      pointer-events: none;
    }
    
    .input-with-icon input {
      padding-left: 48px;
    }
    
    .remember-forgot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 16px 0;
      font-size: 14px;
    }
    
    .remember-me {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .forgot-link {
      color: var(--brand);
      font-weight: 600;
      transition: opacity 0.2s;
    }
    
    .forgot-link:hover {
      opacity: 0.8;
    }
    
    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 24px 0;
      color: var(--muted-2);
      font-size: 14px;
    }
    
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid var(--border);
    }
    
    .divider span {
      padding: 0 16px;
    }
    
    .register-prompt {
      text-align: center;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      color: var(--text-secondary);
    }
    
    .register-link {
      color: var(--brand);
      font-weight: 700;
      text-decoration: none;
    }
    
    .register-link:hover {
      text-decoration: underline;
    }
    
    @media(max-width: 640px) {
      .logo-icon {
        width: 64px;
        height: 64px;
        font-size: 32px;
      }
      
      .logo-title {
        font-size: 24px;
      }
    }
  /* Password reset modal */
.reset-modal{ position:fixed; inset:0; z-index:9999; display:flex; align-items:center; justify-content:center; padding:16px; }
.reset-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
.reset-dialog{ position:relative; width:100%; max-width:520px; padding:16px 18px; }
.reset-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
.reset-head h3{ margin:0; font-size:18px; }
.reset-grid{ display:grid; gap:12px; }
.reset-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap; }
.hint{ color: var(--muted); font-size: 13px; }
.orline{ display:flex; align-items:center; gap:10px; color:var(--muted-2); font-size:13px; }
.orline::before, .orline::after{ content:""; height:1px; background:var(--border); flex:1; }

</style>
</head>
<body>

<div class="topbar">
  <div class="inner">
    <div class="brand">
      <span class="dot"></span> 
      ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂ö‡∑Ö‡∂∏‡∂´‡∑è‡∂ö‡∂ª‡∂´ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫
    </div>
    <div class="nav">
      <a class="btn ghost" href="index.html">üè† Home</a>
      <a class="btn" href="register.html">‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∂±‡∑ä‡∂±</a>
    </div>
  </div>
</div>

<div class="login-wrapper">
  <div class="login-card">
    
    <!-- Logo Section -->
    <div class="logo-section">
      <div class="logo-icon">üöå</div>
      <h1 class="logo-title">Welcome Back</h1>
      <p class="logo-subtitle">‡∂î‡∂∂‡∂ú‡∑ö ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ß ‡∂á‡∂≠‡∑î‡∂Ω‡∑ä ‡∑Ä‡∂±‡∑ä‡∂±</p>
    </div>
    
    <!-- Login Form Card -->
    <div class="card elevated">
      
      <!-- Error Message -->
      <div id="msg" class="alert error hidden"></div>
      
      <!-- Email Input -->
      <div class="input-group">
        <label>üìß ‡∑Ä‡∑í‡∂Ø‡∑ä‚Äç‡∂∫‡∑î‡∂≠‡∑ä ‡∂≠‡∑ê‡∂¥‡∑ë‡∂Ω</label>
        <div class="input-with-icon">
          <span class="input-icon">‚úâÔ∏è</span>
          <input 
            id="email" 
            type="email" 
            placeholder="name@example.com"
            autocomplete="email"
            autofocus
          />
        </div>
      </div>
      
      <!-- Password Input -->
      <div class="input-group">
        <label>üîí ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫</label>
        <div class="input-with-icon">
          <span class="input-icon">üîë</span>
          <input 
            id="password" 
            type="password" 
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            autocomplete="current-password"
          />
        </div>
      </div>
      
      <!-- Remember & Forgot -->
      <div class="remember-forgot">
        <label class="remember-me">
          <input type="checkbox" id="remember" />
          <span>‡∂∏‡∂≠‡∂ö ‡∂≠‡∂∂‡∑è ‡∂ú‡∂±‡∑ä‡∂±</span>
        </label>
        <a href="#" class="forgot-link">‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∂Ö‡∂∏‡∂≠‡∂ö‡∂Ø?</a>
      </div>
      
      <!-- Login Button -->
      <button class="btn btn-primary" id="btnLogin" style="width:100%; justify-content:center; margin-top:8px;">
        üîì ‡∂á‡∂≠‡∑î‡∂Ω‡∑ä ‡∑Ä‡∂±‡∑ä‡∂±
      </button>
      
      <!-- Divider -->
      <div class="divider">
        <span>‡∑Ñ‡∑ù</span>
      </div>
      
      <!-- Register Prompt -->
      <div class="register-prompt">
        ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∂Ø‡∑ä‡∂Ø? 
        <a href="register.html" class="register-link">‡∂Ø‡∑ê‡∂±‡∑ä ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∑Ä‡∂±‡∑ä‡∂± ‚Üí</a>
      </div>
      
    </div>
    
    <!-- Footer Links -->
    <div style="text-align:center; margin-top:24px; color:var(--muted-2); font-size:13px;">
      <a href="privacy.html" style="color:inherit; margin:0 12px;">Privacy Policy</a>
      <a href="data-protection.html" style="color:inherit; margin:0 12px;">Data Protection</a>
      <a href="about.html" style="color:inherit; margin:0 12px;">About</a>
    </div>
    
  </div>
</div>

<!-- Password reset modal -->
<div id="resetModal" class="reset-modal hidden" aria-hidden="true">
  <div class="reset-backdrop" id="resetBackdrop"></div>
  <div class="card elevated reset-dialog">
    <div class="reset-head">
      <h3>üîÅ ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∑É‡∂ö‡∑É‡∂±‡∑ä‡∂±</h3>
      <button class="btn ghost small" id="resetClose">‚úñ</button>
    </div>

    <div id="resetMsg" class="alert error hidden" style="margin-bottom:10px;"></div>

    <div id="resetStep1" class="reset-grid">
      <div class="hint">Email ‡∂ë‡∂ö ‡∂∏‡∂≠‡∂ö ‡∂±‡∂∏‡∑ä Email ‡∂Ø‡∑è‡∂±‡∑ä‡∂±. Email ‡∂Ö‡∂∏‡∂≠‡∂ö ‡∂±‡∂∏‡∑ä Emp No ‡∂Ø‡∑è‡∂±‡∑ä‡∂± (‡∂î‡∂∂‡∂ú‡∑ö account ‡∂ë‡∂ö‡∂ß ‡∂Ö‡∂Ø‡∑è‡∂Ω email ‡∂ë‡∂ö‡∂ß OTP ‡∂∫‡∑Ä‡∂∫‡∑í).</div>

      <div class="input-group" style="margin:0;">
        <label>üìß Email</label>
        <input id="resetEmail" type="email" placeholder="name@example.com" autocomplete="email"/>
      </div>

      <div class="orline"><span>‡∑Ñ‡∑ù</span></div>

      <div class="input-group" style="margin:0;">
        <label>üÜî Emp No</label>
        <input id="resetEmpNo" type="text" placeholder="EMP001" autocomplete="off"/>
      </div>

      <div class="reset-actions">
        <button class="btn secondary" id="btnSendOtp">üì® OTP ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±</button>
      </div>
    </div>

    <div id="resetStep2" class="reset-grid hidden">
      <div class="hint">OTP ‡∂ë‡∂ö ‡∂∏‡∑í‡∂±‡∑í‡∂≠‡∑ä‡∂≠‡∑î 5‡∂ö‡∑ä ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î‡∂∫‡∑í. ‡∂Ø‡∑Ä‡∑É‡∂ß ‡∂â‡∂Ω‡∑ä‡∂Ω‡∑í‡∂∫ ‡∑Ñ‡∑ê‡∂ö‡∑ä‡∂ö‡∑ö ‡∑Ä‡∑è‡∂ª 3‡∂ö‡∑ä ‡∂¥‡∂∏‡∂´‡∑í.</div>

      <div class="input-group" style="margin:0;">
        <label>üî¢ OTP (6 ‡∂Ö‡∂Ç‡∂ö)</label>
        <input id="resetOtp" type="text" inputmode="numeric" maxlength="6" placeholder="123456" autocomplete="one-time-code"/>
      </div>

      <div class="input-group" style="margin:0;">
        <label>üîí ‡∂±‡∑Ä ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫</label>
        <input id="resetNewPass" type="password" placeholder="‡∂Ö‡∑Ä‡∂∏‡∂∫‡∑ô‡∂±‡∑ä ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î 6‡∂ö‡∑ä" autocomplete="new-password"/>
      </div>

      <div class="input-group" style="margin:0;">
        <label>üîí ‡∂±‡∑Ä ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ (‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±)</label>
        <input id="resetNewPass2" type="password" placeholder="‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ß‡∂∫‡∑í‡∂¥‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±" autocomplete="new-password"/>
      </div>

      <div class="reset-actions">
        <button class="btn ghost" id="btnResendOtp">‚Üª OTP ‡∂±‡∑ê‡∑Ä‡∂≠</button>
        <button class="btn secondary" id="btnDoReset">‚úÖ Reset</button>
      </div>
    </div>
  </div>
</div>

<script>
// Forgot password modal
const resetModal = document.getElementById("resetModal");
const resetMsg = document.getElementById("resetMsg");
const resetStep1 = document.getElementById("resetStep1");
const resetStep2 = document.getElementById("resetStep2");
const resetEmail = document.getElementById("resetEmail");
const resetEmpNo = document.getElementById("resetEmpNo");
const resetOtp = document.getElementById("resetOtp");
const resetNewPass = document.getElementById("resetNewPass");
const resetNewPass2 = document.getElementById("resetNewPass2");

// Store only the identifier that the user used (email OR emp_no)
let resetIdentifier = {};

function openResetModal(){
  resetMsg.classList.add("hidden");
  resetMsg.textContent = "";
  resetStep2.classList.add("hidden");
  resetStep1.classList.remove("hidden");
  resetOtp.value = "";
  resetNewPass.value = "";
  resetNewPass2.value = "";
  resetEmail.value = document.getElementById("email").value.trim();
  resetEmpNo.value = "";
  resetModal.classList.remove("hidden");
  resetModal.setAttribute("aria-hidden", "false");
  resetEmail.focus();
}

function closeResetModal(){
  resetModal.classList.add("hidden");
  resetModal.setAttribute("aria-hidden", "true");
}

function showResetError(message){
  resetMsg.textContent = "‚ùå " + (message || "‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠");
  resetMsg.classList.remove("hidden");
}

document.querySelector(".forgot-link").addEventListener("click", (e) => {
  e.preventDefault();
  openResetModal();
});

document.getElementById("resetClose").addEventListener("click", (e) => {
  e.preventDefault();
  closeResetModal();
});

document.getElementById("resetBackdrop").addEventListener("click", closeResetModal);

async function requestOtp(){
  resetMsg.classList.add("hidden");
  const email = resetEmail.value.trim();
  const emp_no = resetEmpNo.value.trim();
  if(!email && !emp_no) return showResetError("Email ‡∑Ñ‡∑ù Emp No ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");

  // Prefer email if both provided
  const payload = email ? { email } : { emp_no };
  // IMPORTANT: do not keep empty-string fields, backend validates formats
  resetIdentifier = payload;

  const btn = document.getElementById("btnSendOtp");
  btn.disabled = true;
  const old = btn.textContent;
  btn.textContent = "‚è≥ ‡∂∫‡∑Ä‡∂∏‡∑í‡∂±‡∑ä...";
  try{
    await api("/auth/password-reset/request", { method:"POST", body: JSON.stringify(payload) });
    toast("üì® OTP ‡∂∫‡∑Ä‡∂Ω‡∑è ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è");
    resetStep1.classList.add("hidden");
    resetStep2.classList.remove("hidden");
    resetOtp.focus();
  }catch(e){
    showResetError(e.message);
  }finally{
    btn.disabled = false;
    btn.textContent = old;
  }
}

async function doReset(){
  resetMsg.classList.add("hidden");
  const otp = resetOtp.value.trim();
  const p1 = resetNewPass.value;
  const p2 = resetNewPass2.value;

  if(!otp || !/^\d{6}$/.test(otp)) return showResetError("OTP ‡∂ë‡∂ö 6 ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫‡∑í.");
  if(!p1 || p1.length < 6) return showResetError("‡∂±‡∑Ä ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∂Ö‡∑Ä‡∂∏‡∂∫‡∑ô‡∂±‡∑ä ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î 6‡∂ö‡∑ä ‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫‡∑í.");
  if(p1 !== p2) return showResetError("‡∂±‡∑Ä ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø ‡∂Ø‡∑ô‡∂ö ‡∂ë‡∂ö‡∂ß ‡∂ú‡∑ê‡∂Ω‡∂¥‡∑ô‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∑ê‡∑Ñ‡∑ê.");

  const payload = Object.assign({}, resetIdentifier, { otp, new_password: p1 });

  const btn = document.getElementById("btnDoReset");
  btn.disabled = true;
  const old = btn.textContent;
  btn.textContent = "‚è≥ ‡∑É‡∂ö‡∑É‡∂∏‡∑í‡∂±‡∑ä...";
  try{
    await api("/auth/password-reset/confirm", { method:"POST", body: JSON.stringify(payload) });
    toast("‚úÖ ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∑Ä‡∑î‡∂´‡∑è");
    closeResetModal();
    // Focus password field for login
    document.getElementById("password").focus();
  }catch(e){
    showResetError(e.message);
  }finally{
    btn.disabled = false;
    btn.textContent = old;
  }
}

document.getElementById("btnSendOtp").addEventListener("click", (e) => { e.preventDefault(); requestOtp(); });
document.getElementById("btnResendOtp").addEventListener("click", (e) => { e.preventDefault(); requestOtp(); });
document.getElementById("btnDoReset").addEventListener("click", (e) => { e.preventDefault(); doReset(); });

// Enter key support
document.getElementById("email").addEventListener('keypress', (e) => {
  if(e.key === 'Enter') document.getElementById("password").focus();
});

document.getElementById("password").addEventListener('keypress', (e) => {
  if(e.key === 'Enter') document.getElementById("btnLogin").click();
});

// Login handler
document.getElementById("btnLogin").onclick = async ()=>{
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const msg = document.getElementById("msg");
  const btn = document.getElementById("btnLogin");
  
  // Validation
  if(!email || !password) {
    msg.textContent = "‚ö†Ô∏è ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂¥‡∑î‡∂ª‡∑Ä‡∂±‡∑ä‡∂±";
    msg.classList.remove("hidden");
    return;
  }
  
  msg.classList.add("hidden");
  btn.disabled = true;
  btn.textContent = "‚è≥ ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂∏‡∑í‡∂±‡∑ä...";
  
  try{
    const d = await api("/auth/login", { 
      method:"POST", 
      body: JSON.stringify({ email, password }) 
    });
    
    setToken(d.token);
    
    // Save remember me preference
    if(document.getElementById("remember").checked) {
      localStorage.setItem("rememberedEmail", email);
    }
    
    const me = await loadMe();
    const role = me.me && me.me.role;
    
    // Show success
    toast("‚úÖ ‡∑É‡∑è‡∂Ø‡∂ª‡∂∫‡∑ô‡∂±‡∑ä ‡∂¥‡∑í‡∑Ö‡∑í‡∂ú‡∂±‡∑í‡∂∏‡∑î!");
    
    // Redirect based on role
    setTimeout(() => {
      if(role==="ADMIN") location.href="admin.html";
      else if(role==="HOD") location.href="hod.html";
      else if(role==="TA") location.href="ta.html";
      else if(role==="HR") location.href="hr.html";
      else if(role==="EMP") location.href="emp.html";
      else if(role==="PLANNING") location.href="planning.html";
      else location.href="index.html";
    }, 500);
    
  }catch(e){
    msg.textContent = "‚ùå " + (e.message || "‡∂á‡∂≠‡∑î‡∂Ω‡∑ä ‡∑Ä‡∑ì‡∂∏ ‡∂Ö‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.");
    msg.classList.remove("hidden");
    btn.disabled = false;
    btn.textContent = "üîì ‡∂á‡∂≠‡∑î‡∂Ω‡∑ä ‡∑Ä‡∂±‡∑ä‡∂±";
  }
};

// Load remembered email
window.addEventListener('DOMContentLoaded', () => {
  const remembered = localStorage.getItem("rememberedEmail");
  if(remembered) {
    document.getElementById("email").value = remembered;
    document.getElementById("remember").checked = true;
    document.getElementById("password").focus();
  }
});
</script>

</body>
</html>
